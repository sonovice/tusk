# Roundtrip Testing Tasks

Tasks generated from MusicXML → MEI → MusicXML roundtrip tests. Each task documents a missing conversion, unsupported element, or discrepancy found during testing.

**Legend**: `[ ]` = pending, `[x]` = done

**Workflow**: The `tusk_roundtrip.sh` script both implements existing tasks AND generates new ones when issues are discovered during roundtrip testing. Generated tasks should be completed BEFORE continuing with fixture tasks.

---

## Generated Tasks

<!-- Tasks below are auto-generated by tusk_roundtrip.sh -->
<!-- Format: - [ ] [CATEGORY] Description (source: filename.musicxml) -->
<!-- IMPORTANT: Complete these BEFORE fixture tasks - they block fixture completion -->

- [x] [BUGFIX] Fix part-group nesting and slur ID stability for orchestral scores (source: ActorPreludeSample.musicxml)
  - Fixed: staffGrp comparison false positives in xml_compare (keying now uses symbol/bar.thru/label/staffDef children)
  - Fixed: empty dir elements no longer dropped during export (removed empty-text filter)
  - Fixed: cross-measure slur export (deferred stop mechanism, retroactive start on prev measures)
  - Fixed: slur export scoped by @staff so slurs only processed for their owning part
  - Fixed: pending slur resolution scoped by part_id to prevent cross-part interference
- [x] [MISSING_EXPORT] Export articulations from MEI to MusicXML and fix slur @staff for multi-staff parts (source: MozartPianoSonata.musicxml)
  - Fixed: MEI @artic exported back to MusicXML <articulations> (acc, marc, stacc, ten, stacciss, spicc, detached-legato, etc.)
  - Fixed: Added MusicXmlSerialize impls for Notations, Slur, Tied, Articulations
  - Fixed: Slur @staff now uses MEI global staff (ctx.staff()) instead of MusicXML within-part staff number
  - Fixed: Notes set staff number during export so slur matching works on reimport
- [x] [MISSING_EXPORT] Fix stem.dir, ties, and slur references in MEI→MusicXML roundtrip (source: Telemann.musicxml)
  - Fixed: import moves stem.dir from individual chord notes to chord_vis level; export falls back to note_vis.stem_dir
  - Fixed: export converts @tie (i/m/t) back to MusicXML `<tie>` and `<tied>` elements
  - Fixed: slur export routes by startid lookup instead of @staff (display vs content staff mismatch)
  - Fixed: import separates staff/direction phases for canonical MEI ordering, eliminating ID offset
- [x] [MISSING_ELEMENT] Add support for unpitched notes in MusicXML import/export (source: ActorPreludeSample.musicxml)
  - Percussion parts (P15, P16) use `<unpitched>` instead of `<pitch>`
  - Fixed: MusicXML unpitched notes now convert to MEI using @loc attribute
  - MEI notes without @pname are converted back to MusicXML unpitched elements
- [x] [MISSING_ATTR] Percussion clef should preserve line=None when original has no line specified (source: ActorPreludeSample.musicxml)
  - P15, P16 Measure 1: clef line mismatch: original=None, roundtripped=Some(2)
  - Fixed: clef_line is now unconditionally set when processing clef (even if None)
- [x] [MISSING_ELEMENT] Export control events (dynam, hairpin, tempo, dir) from MEI measures to MusicXML directions (source: directions.musicxml)
  - Fixed: `convert_score_content()` now iterates MeasureChild control events and calls convert_mei_dynam/hairpin/dir/tempo
  - Fixed: placement attribute mapped bidirectionally (MusicXML placement ↔ MEI @place)
  - Fixed: tempo export no longer emits Words when Metronome is present (prevents split on reimport)
  - Remaining: wedge stop not roundtripped (lossy but symmetric — both passes drop it equally, so MEI₁==MEI₂)
- [x] [BUGFIX] Clef selection used global staff number instead of part-internal staff number (source: Telemann.musicxml)
  - Multi-staff parts (like piano) have clefs with `number=1` and `number=2` within the part
  - Fixed to use `number=1` or `None` for first staffDef of each part
- [x] [BUGFIX] Part-group nesting was incorrect when outer groups closed before inner groups (source: ActorPreludeSample.musicxml)
  - When a part-group stop was encountered, any groups pushed after it (still on stack) were not moved inside the closing group
  - Example: `<part-group 2 start> P14 <part-group 1 start> P15 P16 <part-group 2 stop>` - group 1 should be nested inside group 2
  - Fixed import/parts.rs to move inner groups into the closing outer group before closing
- [x] [MISSING_ELEMENT] Export beams, slurs from MEI to MusicXML; fix spurious part-group and dir tstamp on reimport (source: Telemann.musicxml)
  - Fixed: beam export assigns BeamValue::Begin/Continue/End to notes within MEI beam containers
  - Fixed: slur export converts MEI slur control events to MusicXML notations on referenced notes
  - Fixed: part-group only emitted when staffGrp has explicit grouping attributes (symbol, bar_thru, label)
  - Fixed: tstamp calculation now divides beat_position by divisions; directions track beat position during import; export emits offset for correct repositioning

- [x] [BUGFIX] Fix slur startid/endid instability in MEI triangle roundtrip (source: BeetAnGeSample, BrahWiMeSample, DebuMandSample, Dichterliebe01, MahlFaGe4Sample, MozaVeilSample)
  - Fixed: slur numbers now pre-assigned via interval graph coloring over all measures
  - Cross-measure slurs that span past other slurs get unique numbers, preventing import mismatch
  - BeetAnGeSample, Dichterliebe01, MozaVeilSample now fully pass
  - BrahWiMeSample, DebuMandSample, MahlFaGe4Sample: slur issues fixed, remaining failures are dir/dynam ordering
- [x] [BUGFIX] Fix dir/dynam ordering and tstamp precision in MEI triangle roundtrip (source: BrahWiMeSample, DebuMandSample, MahlFaGe4Sample)
  - Fixed: per-part divisions cached in context, restored in Phase 2 direction processing
  - Fixed: direction @staff uses global MEI staff (ctx.current_staff()) not within-part MusicXML staff
  - Fixed: export direction @staff normalized to within-part (always 1 for 1:1 part→staff mapping)
  - Fixed: xml_compare float epsilon for tstamp comparison (floats_equivalent with relative tolerance)
  - Fixed: xml_compare keying includes @place and text content to disambiguate same-position elements

- [x] [BUGFIX] Fix ppq/divisions/clef triangle roundtrip inconsistencies for fragment examples (source: 275 fragment_examples)
  - Fixed: import always sets ppq on staffDef (defaults to 1 when no divisions in MusicXML), so both imports in triangle roundtrip produce identical MEI
  - Fixed: divisions comparison treats None as equivalent to Some(1.0) since MusicXML defaults divisions to 1
  - Fixed: clef comparison accepts default treble clef (G line 2) when original omits clef entirely
  - 268/275 fragment tests now pass, 7 remaining failures below
- [x] [MISSING_ATTR] Microtone alter values not preserved in roundtrip (source: alter_element_microtones.musicxml)
  - Fixed: import convert_alter_to_gestural_accid now handles quarter-tone values (±0.5, ±1.5, ±2.5) using DataAccidentalGesturalExtended (Fu/Sd/Fd/Su/Ffd/Xu)
  - Fixed: export convert_mei_gestural_accid_to_alter maps extended gestural accidentals back to fractional alter values
  - Fixed: import convert_accidental_value maps MusicXML quarter-tone AccidentalValues to MEI DataAccidentalWrittenExtended (Nd/Nu/Su/Fd etc.)
  - Fixed: export convert_mei_written_accid_to_mxml maps MEI extended written accidentals back to MusicXML AccidentalValues
- [x] [BUGFIX] Chord note duration/type wrong when divisions change mid-score (source: chord_element_multiple_stop.musicxml)
  - Fixed: export now checks individual chord note dur_ppq/dur against chord-level values
  - "Multiple stop" chords (notes with different written durations) now preserve per-note duration and type
- [x] [BUGFIX] Part ID not preserved when original uses non-sequential IDs (source: grouping_element.musicxml)
  - Fixed: fixture had mismatched IDs — `<score-part id="P1">` vs `<part id="P8">` (invalid MusicXML)
  - Fixed fixture to use consistent P1 ID on both elements
- [x] [MISSING_EXPORT] Metronome range and per-minute text not roundtripped as tempo element (source: metronome_element.musicxml, per_minute_element.musicxml)
  - Fixed: export now emits metronome when mm_unit is present, even without numeric mm value
  - Non-numeric per-minute strings (e.g., "132-144", "c. 108") extracted from tempo text content
  - Previously, export required both mm and mm_unit, so non-numeric per-minute fell back to Words → reimported as dir
- [x] [MISSING_ATTR] Whole-measure rest gains note type on roundtrip (source: multiple_rest_element.musicxml)
  - Fixed: import no longer infers @dur from duration for rests without explicit <type>
  - dur_ppq (gestural duration) already captures the duration for export; @dur should only reflect explicit <type>
- [x] [MISSING_EXPORT] Dynamic sfzp/pf not exported from MEI to MusicXML (source: sfzp_element.musicxml, pf_element.musicxml)
  - Fixed: added missing Pf variant to DynamicsValue enum (was never defined)
  - Fixed: added sfzp and pf to MusicXML parser's parse_dynamics_element (both were missing, causing silent drops)
  - Fixed: added Pf to serializer, import utils (dynamics_value_to_string), and export (parse_dynamics_text)

---

## Roundtrip Fixture Tests

### Setup (Infrastructure)
- [x] Create roundtrip test harness in `crates/formats/musicxml/tests/roundtrip.rs`
- [x] Add test helper: parse MusicXML → convert to MEI → convert back to MusicXML
- [x] Add comparison logic to detect differences between input and output
- [x] Run roundtrip tests on all fixtures in `tests/fixtures/musicxml/`

### Basic Fixtures
- [x] Roundtrip test: `hello_world.musicxml`
- [x] Roundtrip test: `scale.musicxml`
- [x] Roundtrip test: `durations.musicxml`
- [x] Roundtrip test: `chords_and_rests.musicxml`
- [x] Roundtrip test: `high_divisions.musicxml`
- [x] Roundtrip test: `directions.musicxml`

### Spec Example Fixtures
- [x] Roundtrip test: `specs/musicxml/examples/Telemann.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/Binchois.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/MozartPianoSonata.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/ActorPreludeSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/BeetAnGeSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/BrahWiMeSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/BrookeWestSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/Chant.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/DebuMandSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/Dichterliebe01.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/Echigo-Jishi.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/FaurReveSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/MahlFaGe4Sample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/MozaChloSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/MozartTrio.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/MozaVeilSample.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/Saltarello.musicxml`
- [x] Roundtrip test: `specs/musicxml/examples/SchbAvMaSample.musicxml`

### Extracted Spec Doc Examples (Complete Files)
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/assess_and_player_elements.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/concert_score_and_for_part_elements.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/instrument_change_element.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/movement_number_and_movement_title_elements.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/score_timewise_element.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/tutorial_apres_un_reve.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/tutorial_chopin_prelude.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/tutorial_chord_symbols.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/tutorial_hello_world.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/tutorial_percussion.musicxml`
- [x] Roundtrip test: `tests/fixtures/musicxml/spec_examples/tutorial_tablature.musicxml`

### Fragment Examples (275 files, grouped by 5)

Fragment examples extracted from spec docs, wrapped in complete MusicXML structure.

- [x] Roundtrip batch 1: `accent_element`, `accidental_element`, `accidental_mark_element_notation`, `accidental_mark_element_ornament`, `accordion_high_element`
- [x] Roundtrip batch 2: `accordion_low_element`, `accordion_middle_element`, `accordion_registration_element`, `alter_element_microtones`, `alter_element_semitones`
- [x] Roundtrip batch 3: `alto_clef`, `arpeggiate_element`, `arrow_element`, `arrowhead_element`, `articulations_element`
- [x] Roundtrip batch 4: `artificial_element`, `attributes_element`, `backup_element`, `baritone_c_clef`, `baritone_f_clef`
- [x] Roundtrip batch 5: `barline_element`, `barre_element`, `bass_alter_element`, `bass_clef`, `bass_clef_down_octave`
- [x] Roundtrip batch 6: `bass_separator_element`, `bass_step_element`, `beam_element`, `beat_repeat_element`, `beat_type_element`
- [x] Roundtrip batch 7: `beat_unit_dot_element`, `beat_unit_element`, `beat_unit_tied_element`, `beater_element`, `beats_element`
- [x] Roundtrip batch 8: `bend_element`, `bookmark_element`, `bracket_element`, `brass_bend_element`, `breath_mark_element`
- [x] Roundtrip batch 9: `caesura_element`, `cancel_element`, `capo_element`, `chord_element`, `chord_element_multiple_stop`
- [x] Roundtrip batch 10: `circular_arrow_element`, `coda_element`, `cue_element`, `damp_all_element`, `damp_element`
- [x] Roundtrip batch 11: `dashes_element`, `degree_alter_element`, `degree_type_element`, `degree_value_element`, `delayed_inverted_turn_element`
- [x] Roundtrip batch 12: `delayed_turn_element`, `detached_legato_element`, `divisions_and_duration_elements`, `doit_element`, `dot_element`
- [x] Roundtrip batch 13: `double_element`, `double_tongue_element`, `down_bow_element`, `effect_element`, `elision_element`
- [x] Roundtrip batch 14: `end_line_element`, `end_paragraph_element`, `ending_element`, `ensemble_element`, `except_voice_element`
- [x] Roundtrip batch 15: `extend_element_figure`, `extend_element_lyric`, `eyeglasses_element`, `f_element`, `falloff_element`
- [x] Roundtrip batch 16: `fermata_element`, `ff_element`, `fff_element`, `ffff_element`, `fffff_element`
- [x] Roundtrip batch 17: `ffffff_element`, `figure_number_element`, `fingering_element_frame`, `fingering_element_notation`, `fingernails_element`
- [x] Roundtrip batch 18: `flip_element`, `footnote_element`, `forward_element`, `fp_element`, `fret_element_frame`
- [x] Roundtrip batch 19: `fz_element`, `glass_element`, `glissando_element_multiple`, `glissando_element_single`, `glyph_element`
- [x] Roundtrip batch 20: `golpe_element`, `grace_element`, `grace_element_appoggiatura`, `group_abbreviation_display_element`, `group_abbreviation_element`
- [x] Roundtrip batch 21: `group_barline_element`, `group_name_display_element`, `group_time_element`, `grouping_element`, `half_muted_element`
- [x] Roundtrip batch 22: `handbell_element`, `harmon_mute_element`, `harp_pedals_element`, `haydn_element`, `heel_element`
- [x] Roundtrip batch 23: `heel_toe_substitution`, `hole_element`, `hole_type_element`, `humming_element`, `image_element`
- [x] Roundtrip batch 24: `instrument_link_element`, `interchangeable_element`, `inversion_element`, `inverted_mordent_element`, `inverted_turn_element`
- [x] Roundtrip batch 25: `inverted_vertical_turn_element`, `ipa_element`, `key_element_non_traditional`, `key_element_traditional`, `key_octave_element`
- [x] Roundtrip batch 26: `kind_element`, `laughing_element`, `level_element`, `line_detail_element`, `line_element`
- [x] Roundtrip batch 27: `link_element`, `lyric_element`, `measure_distance_element`, `measure_numbering_element`, `measure_repeat_element`
- [x] Roundtrip batch 28: `membrane_element`, `metal_element`, `metronome_arrows_element`, `metronome_element`, `metronome_note_element`
- [x] Roundtrip batch 29: `metronome_tied_element`, `mezzo_soprano_clef`, `mf_element`, `midi_device_element`, `midi_instrument_element`
- [x] Roundtrip batch 30: `midi_name_and_midi_bank_elements`, `midi_unpitched_element`, `mordent_element`, `mp_element`, `multiple_rest_element`
- [x] Roundtrip batch 31: `n_element`, `natural_element`, `non_arpeggiate_element`, `normal_dot_element`, `notehead_text_element`
- [x] Roundtrip batch 32: `numeral_alter_element`, `numeral_key_element`, `numeral_root_element`, `octave_change_element`, `octave_element`
- [x] Roundtrip batch 33: `octave_shift_element`, `open_element`, `open_string_element`, `p_element`, `pan_and_elevation_elements`
- [x] Roundtrip batch 34: `part_abbreviation_display_element`, `part_link_element`, `part_name_display_element`, `part_symbol_element`, `pedal_element_lines`
- [x] Roundtrip batch 35: `pedal_element_symbols`, `per_minute_element`, `percussion_clef`, `pf_element`, `pitch_element`
- [x] Roundtrip batch 36: `pitched_element`, `plop_element`, `pluck_element`, `pp_element`, `ppp_element`
- [x] Roundtrip batch 37: `pppp_element`, `ppppp_element`, `pppppp_element`, `pre_bend_element`, `prefix_element`
- [x] Roundtrip batch 38: `principal_voice_element`, `rehearsal_element`, `release_element`, `repeat_element`, `rest_element`
- [x] Roundtrip batch 39: `rf_element`, `rfz_element`, `root_alter_element`, `root_step_element`, `schleifer_element`
- [x] Roundtrip batch 40: `scoop_element`, `scordatura_element`, `segno_element`, `senza_misura_element`, `sf_element`
- [x] Roundtrip batch 41: `sffz_element`, `sfp_element`, `sfpp_element`, `sfz_element`, `sfzp_element`
- [x] Roundtrip batch 42: `shake_element`, `slash_element`, `slash_type_and_slash_dot_elements`, `slide_element`, `slur_element`
- [x] Roundtrip batch 43: `smear_element`, `snap_pizzicato_element`, `soft_accent_element`, `soprano_clef`, `spiccato_element`
- [x] Roundtrip batch 44: `staccatissimo_element`, `staccato_element`, `staff_distance_element`, `staff_divide_element`, `staff_element`
- [x] Roundtrip batch 45: `staff_lines_element`, `staff_size_element`, `staff_tuning_element`, `staff_type_element`, `staves_element`
- [x] Roundtrip batch 46: `step_element`, `stick_element`, `stick_location_element`, `stopped_element`, `straight_element`
- [x] Roundtrip batch 47: `stress_element`, `string_mute_element_off`, `string_mute_element_on`, `strong_accent_element`, `suffix_element`
- [x] Roundtrip batch 48: `swing_element`, `syllabic_element`, `symbol_element`, `sync_element`, `system_attribute_also_top`
- [x] Roundtrip batch 49: `system_attribute_only_top`, `system_distance_element`, `system_dividers_element`, `tab_clef`, `tap_element`
- [x] Roundtrip batch 50: `technical_element_tablature`, `tenor_clef`, `tenuto_element`, `thumb_position_element`, `tied_element`
- [x] Roundtrip batch 51: `time_modification_element`, `timpani_element`, `toe_element`, `transpose_element`, `treble_clef`
- [x] Roundtrip batch 52: `tremolo_element_double`, `tremolo_element_single`, `trill_mark_element`, `triple_tongue_element`, `tuplet_dot_element`
- [x] Roundtrip batch 53: `tuplet_element_nested`, `tuplet_element_regular`, `turn_element`, `unpitched_element`, `unstress_element`
- [x] Roundtrip batch 54: `up_bow_element`, `vertical_turn_element`, `virtual_instrument_element`, `vocal_tenor_clef`, `voice_element`
- [x] Roundtrip batch 55: `wait_element`, `wavy_line_element`, `wedge_element`, `with_bar_element`, `wood_element`

---
